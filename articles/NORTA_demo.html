<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="simdata">
<title>simdata: NORTA based simulation designs • simdata</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="simdata: NORTA based simulation designs">
<meta property="og:description" content="simdata">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">simdata</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.9003</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Demo.html">simdata: A package for creating simulated datasets</a>
    <a class="dropdown-item" href="../articles/NORTA_demo.html">simdata: NORTA based simulation designs</a>
    <a class="dropdown-item" href="../articles/Technical_documentation.html">simdata: Technical documentation</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/matherealize/simdata/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>simdata: NORTA based simulation designs</h1>
                        <h4 data-toc-skip class="author">Michael
Kammer</h4>
            
            <h4 data-toc-skip class="date">2023-08-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/matherealize/simdata/blob/HEAD/vignettes/NORTA_demo.Rmd" class="external-link"><code>vignettes/NORTA_demo.Rmd</code></a></small>
      <div class="d-none name"><code>NORTA_demo.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This document describes the workflow to define NORmal-To-Anything
(NORTA) based simulation designs using the <code>simdata</code> package.
The method is very useful to re-create existing datasets through a
parametric approximation for usage in simulation studies. It is also
quite easy to use, and allows the definition of presets for sharing
simulation setups. General details of the methodology and further
references are given in e.g.  <span class="citation">Cario and Nelson
(1997)</span> and <span class="citation">Ghosh and Henderson
(2003)</span>.</p>
<p>In this vignette we will prefix all relevant function calls by
<code>::</code> to show the package which implements the function - this
is not necessary but only done for demonstration purposes.</p>
<div class="section level3">
<h3 id="outline">Outline of NORTA<a class="anchor" aria-label="anchor" href="#outline"></a>
</h3>
<p>The goal of the NORTA procedure is to produce identically
independently distributed (iid) samples from random variables with a
given correlation structure (Pearson correlation matrix) and given
marginal distributions, thereby e.g. approximating existing
datasets.</p>
<p>Following <span class="citation">Ghosh and Henderson (2003)</span>,
we want to sample iid replicates of the random vector <span class="math inline">\(X = (X_1, X_2, \ldots, X_k)\)</span>. Denote by
<span class="math inline">\(F_i(s) = P(X_i \leq s)\)</span> the
distribution functions (i.e. the marginal distributions) of the
components of <span class="math inline">\(X\)</span>, and by <span class="math inline">\(\Sigma_X\)</span> the <span class="math inline">\(k \times k\)</span> correlation matrix of <span class="math inline">\(X\)</span>. Then NORTA proceeds as follows:</p>
<ul>
<li>Generate multivariate standard normal random vectors (i.e mean 0,
variance 1) <span class="math inline">\(Z = (Z_1, Z_2, \ldots,
Z_k)\)</span> with a correlation matrix <span class="math inline">\(\Sigma_Z\)</span>.</li>
<li>Compute the random vector <span class="math inline">\(X\)</span> via
<span class="math inline">\(X_i := F_i^{-1}(\Phi(Z_i))\)</span>, where
<span class="math inline">\(\Phi\)</span> denotes the distribution
function of the standard normal distribution, and <span class="math inline">\(F_i^{-1}(t) := \inf\{x: F_i(x) \geq t\}\)</span>
is the quantile function of <span class="math inline">\(X_i\)</span>.</li>
</ul>
<p>The resulting vector <span class="math inline">\(X\)</span> then has
the desired marginal distribution. To obtain the target correlation
structure <span class="math inline">\(\Sigma_X\)</span>, the correlation
matrix <span class="math inline">\(\Sigma_Z\)</span> for the first step
has to be chosen appropriately. This can be achieved via solving
univariable optimisation problems for each pair of variables <span class="math inline">\(X_i\)</span> and <span class="math inline">\(X_j\)</span> in <span class="math inline">\(X\)</span> and is part of the <code>simdata</code>
package.</p>
</div>
<div class="section level3">
<h3 id="caveats-of-norta">Caveats of NORTA<a class="anchor" aria-label="anchor" href="#caveats-of-norta"></a>
</h3>
<p>The NORTA procedure has some known limitations, which may lead to
discrepancies between the target correlation structure and the
correlation structure obtained from the sampling process. These are,
however, partly alleviated when using existing datasets as templates, or
by special techniques within <code>simdata</code>.</p>
<ul>
<li>Not all combinations of given marginal distributions and target
correlation are feasible by the nature of the variables. This is not an
issue when an existing dataset is used as template, since that
demonstrates that the combination exists.</li>
<li>The optimisation procedure to obtain <span class="math inline">\(\Sigma_Z\)</span> may lead to a matrix which is
not positive definite (since the optimisation is only done for pairs of
variables), and therefore not a proper correlation matrix. To alleviate
this, the <code>simdata</code> package ensures positive definiteness by
using the closest positive definite matrix instead. This may lead to
discrepancies between the target correlation and the achieved
correlation structure.</li>
<li>NORTA cannot reproduce non-linear relationships between
variables.</li>
<li>The optimisation procedure to obtain <span class="math inline">\(\Sigma_Z\)</span> may take a while to compute when
the number of variables increases. This is alleviated through the fact
that this computation has to be done only a single time, during
definition of the simulation design. All further simulation iterations
only use the optimisation result and are therefore not subject to this
issue.</li>
<li>When applied to an existing dataset, NORTA relies on the estimation
of the target correlation matrix and marginal distributions. More
complex data (e.g. special marginal distributions, complex correlation
structure) therefore requires more observations for an accurate
representation.</li>
</ul>
</div>
<div class="section level3">
<h3 id="comparison-to-other-methods">Comparison to other methods<a class="anchor" aria-label="anchor" href="#comparison-to-other-methods"></a>
</h3>
<p>NORTA is well suited to re-create existing datasets through an
explicit parametric approximation. Similar methods exist, that achieve
this through other means. A particularly interesting alternative is the
generation of synthetic datasets using an approach closely related to
multiple imputation, and is implemented in e.g. the
<code>synthpop</code> R package (<span class="citation">Nowok, Raab, and
Dibben (2016)</span>). Its’ primary aim is to achieve confidentiality by
re-creating copies to be shared for existing, sensitive datasets.</p>
<p>In comparison, <code>synthpop</code> potentially offers more flexible
data generation than NORTA, thereby leading to a better approximation of
an original dataset. However, <code>synthpop</code> is also more opaque
than the explicit, user defined specification of correlation and
marginal distributions of NORTA. This also entails that
<code>synthpop</code> can be generally used more like a black-box
approach, which requires little user input, but is also less transparent
than the manual curation of the simulation setup in NORTA. Furthermore,
NORTA allows easy changes to the design to obtain a wide variety of
study designs from a single template dataset, whereas
<code>synthpop</code> is more targeted at re-creating the original
dataset. Both methods therefore have their distinct usecases and
complement each other.</p>
</div>
</div>
<div class="section level2">
<h2 id="workflow-in-simdata">Workflow in <code>simdata</code><a class="anchor" aria-label="anchor" href="#workflow-in-simdata"></a>
</h2>
<p>Given the <a href="#outline">outline of the method</a>, all the user
has to specify to define a NORTA design on <span class="math inline">\(k\)</span> variables are</p>
<ul>
<li>A <span class="math inline">\(k \times k\)</span> target correlation
matrix</li>
<li>The <span class="math inline">\(k\)</span> marginal distributions
for each variable, given as quantile functions</li>
</ul>
<p>These can be estimated from existing datasets of interest,
circumventing some limitations of the NORTA approach. See the <a href="#example">example below</a> for the setup within this package.</p>
<div class="section level3">
<h3 id="some-common-distributions">Some common distributions<a class="anchor" aria-label="anchor" href="#some-common-distributions"></a>
</h3>
<p>The required marginal distributions are given as quantile functions.
R provides implementations of many standard distributions which can be
directly used, see the help on <code>distributions</code>. The quantile
functions use the prefix “q”, as in e.g. <code>qnorm</code> or
<code>qbinom</code>. Further implementations can be found in the
packages <code>extraDistr</code>, <code>actuar</code> and many others
(see <a href="https://cran.r-project.org/web/views/Distributions.html" class="external-link uri">https://cran.r-project.org/web/views/Distributions.html</a>).</p>
</div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>In this example we will setup a NORTA based simulation design for a
dataset extracted from the National Health And Nutrition Examination
Survey (NHANES), accessible in R via several packages (we use the
<code>nhanesA</code> package in this demo).</p>
<div class="section level3">
<h3 id="load-dataset">Load dataset<a class="anchor" aria-label="anchor" href="#load-dataset"></a>
</h3>
<p>First we will load the dataset and extract several variables of
interest, namely gender (‘Gender’), age (‘Age’), race (‘Race’), weight
(‘Weight’), bmi (‘BMI’), systolic (‘BPsys’) and diastolic blood pressure
(‘BPdia’). These variabes demonstrate several different kinds of
distributions. For a detailed description of the data, please see the
documentation at <a href="https://www.cdc.gov/nchs/nhanes.htm" class="external-link uri">https://www.cdc.gov/nchs/nhanes.htm</a>. Here we are not
concerned with the exact codings of the variables, so we will not add
labels to factor variables.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">=</span> <span class="fu">nhanesA</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nhanesA/man/nhanes.html" class="external-link">nhanes</a></span><span class="op">(</span><span class="st">"DEMO_J"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="fu">nhanesA</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nhanesA/man/nhanes.html" class="external-link">nhanes</a></span><span class="op">(</span><span class="st">"BMX_J"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="fu">nhanesA</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nhanesA/man/nhanes.html" class="external-link">nhanes</a></span><span class="op">(</span><span class="st">"BPX_J"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>Gender <span class="op">=</span> <span class="va">RIAGENDR</span>, </span>
<span>                Age <span class="op">=</span> <span class="va">RIDAGEYR</span>, </span>
<span>                Race <span class="op">=</span> <span class="va">RIDRETH1</span>, </span>
<span>                Weight <span class="op">=</span> <span class="va">BMXWT</span>, </span>
<span>                BMI <span class="op">=</span> <span class="va">BMXBMI</span>, </span>
<span>                BPsys <span class="op">=</span> <span class="va">BPXSY1</span>, </span>
<span>                BPdia <span class="op">=</span> <span class="va">BPXDI1</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Age</span> <span class="op">&gt;</span> <span class="fl">18</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Gender Age Race Weight  BMI BPsys BPdia</span></span>
<span><span class="co">## 1      2  75    4   88.8 38.9   120    66</span></span>
<span><span class="co">## 2      1  56    5   62.1 21.3   108    68</span></span>
<span><span class="co">## 3      1  67    3   74.9 23.5   104    70</span></span>
<span><span class="co">## 4      1  71    5   65.6 22.5   112    60</span></span>
<span><span class="co">## 5      1  61    5   77.7 30.7   120    72</span></span>
<span><span class="co">## 6      1  22    3   74.4 24.5   116    62</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="estimate-target-correlation">Estimate target correlation<a class="anchor" aria-label="anchor" href="#estimate-target-correlation"></a>
</h3>
<p>Using this dataset, we first define the target correlation
<code>cor_target</code> and plot it.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cor_target</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="fu">ggcorrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggcorrplot/man/ggcorrplot.html" class="external-link">ggcorrplot</a></span><span class="op">(</span><span class="va">cor_target</span>, lab <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="NORTA_demo_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="define-marginal-distributions">Define marginal distributions<a class="anchor" aria-label="anchor" href="#define-marginal-distributions"></a>
</h3>
<p>Further, we define a list of marginal distributions <code>dist</code>
representing the individual variables. Each entry of the list must be a
function in one argument, defining the quantile function of the
variable. The order of the entries must correspond to the order in the
target correlation <code>cor_target</code>.</p>
<p>We also use the <code><a href="https://rdrr.io/pkg/fitdistrplus/man/fitdist.html" class="external-link">fitdistrplus::fitdist</a></code> function to find
appropriate distribution candidates and fit their parameters. Decisions
regarding the fit of a distribution can be made using e.g. the Akaike
information criterion (AIC) or Bayesian information criterion (BIC)
displayed by the summary of the fit object returned by the function (the
lower their values, the better the fit).</p>
<p>In case a parametric distribution doesn’t fit very well, we instead
make use of a density estimate and use this to define the marginal
quantile function.</p>
<ul>
<li>Gender: a binomial distribution with <span class="math inline">\(P(2) \approx 0.5\)</span>.</li>
<li>Age: the distribution is not very “nice”.
<ul>
<li>We approximate it using a kernel density estimate using the
<code><a href="https://rdrr.io/r/stats/density.html" class="external-link">stats::density</a></code> function.</li>
<li>Note that the boundaries of the distribution can be more or less
smoothed with the <code>cut</code> parameter.</li>
<li>To obtain a quantile function, first we integrate the density,
normalize it, and then use <code><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">stats::approxfun</a></code> to derive a
univariable quantile function.</li>
</ul>
</li>
<li>Race: a categorical distribution with 5 categories specified by
probabilities
<ul>
<li>Can also be implemented using the categorical distribution from the
package <code>LaplacesDemon</code> implemented via
<code>qcat</code>
</li>
</ul>
</li>
<li>Weight: gamma distribution parameters estimated using
<code><a href="https://rdrr.io/pkg/fitdistrplus/man/fitdist.html" class="external-link">fitdistrplus::fitdist</a></code>
</li>
<li>BMI and systolic blood pressure: log-normal distribution parameters
estimated using <code><a href="https://rdrr.io/pkg/fitdistrplus/man/fitdist.html" class="external-link">fitdistrplus::fitdist</a></code>
</li>
<li>Diastolic blood pressure: normal distribution parameters estimated
using <code><a href="https://rdrr.io/pkg/fitdistrplus/man/fitdist.html" class="external-link">fitdistrplus::fitdist</a></code> after removing zero values from
the data</li>
</ul>
<p>The code to implement these marginal distributions is shown below.
Helper functions to ease the workflow will be implemented in future
versions of the package.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># gender</span></span>
<span><span class="va">dist</span><span class="op">[[</span><span class="st">"Gender"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">qbinom</a></span><span class="op">(</span><span class="va">x</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># age</span></span>
<span><span class="va">dens</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Age</span>, cut <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># cut defines how to deal with boundaries</span></span>
<span><span class="co"># integrate</span></span>
<span><span class="va">int_dens</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Age <span class="op">=</span> <span class="va">dens</span><span class="op">$</span><span class="va">x</span>, cdf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">dens</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># normalize to obtain cumulative distribution function</span></span>
<span><span class="va">int_dens</span><span class="op">[</span>, <span class="st">"cdf"</span><span class="op">]</span> <span class="op">=</span> <span class="va">int_dens</span><span class="op">[</span>, <span class="st">"cdf"</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">int_dens</span><span class="op">[</span>, <span class="st">"cdf"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># derive quantile function</span></span>
<span><span class="co"># outside the defined domain retun minimum and maximum age, respectively</span></span>
<span><span class="va">dist</span><span class="op">[[</span><span class="st">"Age"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approxfun</a></span><span class="op">(</span><span class="va">int_dens</span><span class="op">[</span>, <span class="st">"cdf"</span><span class="op">]</span>, <span class="va">int_dens</span><span class="op">[</span>, <span class="st">"Age"</span><span class="op">]</span>, </span>
<span>                          yleft <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">int_dens</span><span class="op">[</span>, <span class="st">"Age"</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                          yright <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">int_dens</span><span class="op">[</span>, <span class="st">"Age"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># race</span></span>
<span><span class="va">dist</span><span class="op">[[</span><span class="st">"Race"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">x</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.135</span>, <span class="fl">0.227</span>, <span class="fl">0.575</span>, <span class="fl">0.806</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>        labels <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># weight</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu">fitdistrplus</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fitdistrplus/man/fitdist.html" class="external-link">fitdist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Weight</span><span class="op">)</span>, <span class="st">"gamma"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">dist</span><span class="op">[[</span><span class="st">"Weight"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">qgamma</a></span><span class="op">(</span><span class="va">x</span>, shape <span class="op">=</span> <span class="fl">14.44</span>, rate <span class="op">=</span> <span class="fl">0.17</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># bmi</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu">fitdistrplus</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fitdistrplus/man/fitdist.html" class="external-link">fitdist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">BMI</span><span class="op">)</span>, <span class="st">"lnorm"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">dist</span><span class="op">[[</span><span class="st">"BMI"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">qlnorm</a></span><span class="op">(</span><span class="va">x</span>, meanlog <span class="op">=</span> <span class="fl">3.36</span>, sdlog <span class="op">=</span> <span class="fl">0.23</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># systolic blood pressure</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu">fitdistrplus</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fitdistrplus/man/fitdist.html" class="external-link">fitdist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">BPsys</span><span class="op">)</span>, <span class="st">"lnorm"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">dist</span><span class="op">[[</span><span class="st">"BPsys"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">qlnorm</a></span><span class="op">(</span><span class="va">x</span>, meanlog <span class="op">=</span> <span class="fl">4.83</span>, sdlog <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># diastolic blood pressure</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu">fitdistrplus</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fitdistrplus/man/fitdist.html" class="external-link">fitdist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">df</span> <span class="op">%&gt;%</span> </span>
<span>                                         <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">BPdia</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>                                         <span class="fu">pull</span><span class="op">(</span><span class="va">BPdia</span><span class="op">)</span><span class="op">)</span>, <span class="st">"norm"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">dist</span><span class="op">[[</span><span class="st">"BPdia"</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">x</span>, mean <span class="op">=</span> <span class="fl">72.42</span>, sd <span class="op">=</span> <span class="fl">11.95</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulate-data">Simulate data<a class="anchor" aria-label="anchor" href="#simulate-data"></a>
</h3>
<p>Now we can use the <code><a href="../reference/simdesign_norta.html">simdata::simdesign_norta</a></code> to obtain a
design using these specification. After that, we simulate a dataset of
the same size as the original data set using
<code><a href="../reference/simulate_data.html">simdata::simulate_data</a></code>, and compare the resulting summary
statistics and correlation structures.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsgn</span> <span class="op">=</span> <span class="fu">simdata</span><span class="fu">::</span><span class="fu"><a href="../reference/simdesign_norta.html">simdesign_norta</a></span><span class="op">(</span>cor_target_final <span class="op">=</span> <span class="va">cor_target</span>, dist <span class="op">=</span> <span class="va">dist</span>, </span>
<span>                                transform_initial <span class="op">=</span> <span class="va">data.frame</span>,</span>
<span>                                names_final <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dist</span><span class="op">)</span>, seed_initial <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">simdf</span> <span class="op">=</span> <span class="fu">simdata</span><span class="fu">::</span><span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span><span class="va">dsgn</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>, seed <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h3>
<p>Summary statistics of the original and simulated datasets.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      Gender           Age             Race           Weight      </span></span>
<span><span class="co">##  Min.   :1.000   Min.   :19.00   Min.   :1.000   Min.   : 36.20  </span></span>
<span><span class="co">##  1st Qu.:1.000   1st Qu.:34.00   1st Qu.:3.000   1st Qu.: 66.90  </span></span>
<span><span class="co">##  Median :2.000   Median :52.00   Median :3.000   Median : 79.00  </span></span>
<span><span class="co">##  Mean   :1.511   Mean   :50.29   Mean   :3.257   Mean   : 82.68  </span></span>
<span><span class="co">##  3rd Qu.:2.000   3rd Qu.:65.00   3rd Qu.:4.000   3rd Qu.: 94.70  </span></span>
<span><span class="co">##  Max.   :2.000   Max.   :80.00   Max.   :5.000   Max.   :219.60  </span></span>
<span><span class="co">##       BMI            BPsys           BPdia       </span></span>
<span><span class="co">##  Min.   :14.80   Min.   : 72.0   Min.   :  0.00  </span></span>
<span><span class="co">##  1st Qu.:24.70   1st Qu.:112.0   1st Qu.: 64.00  </span></span>
<span><span class="co">##  Median :28.50   Median :124.0   Median : 72.00  </span></span>
<span><span class="co">##  Mean   :29.69   Mean   :126.2   Mean   : 71.85  </span></span>
<span><span class="co">##  3rd Qu.:33.50   3rd Qu.:136.0   3rd Qu.: 80.00  </span></span>
<span><span class="co">##  Max.   :84.40   Max.   :224.0   Max.   :124.00</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">simdf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      Gender            Age             Race           Weight      </span></span>
<span><span class="co">##  Min.   :0.0000   Min.   :16.00   Min.   :1.000   Min.   : 26.18  </span></span>
<span><span class="co">##  1st Qu.:0.0000   1st Qu.:34.04   1st Qu.:3.000   1st Qu.: 68.51  </span></span>
<span><span class="co">##  Median :1.0000   Median :50.74   Median :3.000   Median : 82.24  </span></span>
<span><span class="co">##  Mean   :0.5107   Mean   :49.91   Mean   :3.263   Mean   : 84.66  </span></span>
<span><span class="co">##  3rd Qu.:1.0000   3rd Qu.:64.67   3rd Qu.:4.000   3rd Qu.: 98.63  </span></span>
<span><span class="co">##  Max.   :1.0000   Max.   :82.89   Max.   :5.000   Max.   :206.00  </span></span>
<span><span class="co">##       BMI            BPsys            BPdia       </span></span>
<span><span class="co">##  Min.   :12.44   Min.   : 64.69   Min.   : 28.25  </span></span>
<span><span class="co">##  1st Qu.:24.48   1st Qu.:113.66   1st Qu.: 64.33  </span></span>
<span><span class="co">##  Median :28.55   Median :125.28   Median : 72.42  </span></span>
<span><span class="co">##  Mean   :29.50   Mean   :127.05   Mean   : 72.47  </span></span>
<span><span class="co">##  3rd Qu.:33.61   3rd Qu.:138.92   3rd Qu.: 80.65  </span></span>
<span><span class="co">##  Max.   :64.72   Max.   :204.22   Max.   :117.18</span></span></code></pre>
<p>Correlation structures of the original and simulated datasets.</p>
<p><img src="NORTA_demo_files/figure-html/unnamed-chunk-7-1.png" width="700"><img src="NORTA_demo_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<p>We may also inspect the continuous variables regarding their
univariate and bivariate distributions. The original data is shown in
black, the simulated data is shown in red.</p>
<p><img src="NORTA_demo_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>From this we can observe, that the agreement between the original
data and the simulated data is generally quite good. Note, however, that
e.g. the slightly non-linear relationship between age and diastolic
blood pressure cannot be fully captured by the approach, as expected.
Furthermore, the original data shows some outliers, which are also not
reproducible due to the parametric nature of the NORTA procedure.</p>
</div>
</div>
<div class="section level2">
<h2 id="rsession">R session information<a class="anchor" aria-label="anchor" href="#rsession"></a>
</h2>
<pre><code><span><span class="co">## R version 4.3.1 (2023-06-16)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">## Running under: Ubuntu 22.04.3 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">##  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">## [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] ggcorrplot_0.1.4    patchwork_1.1.3     ggplot2_3.4.3      </span></span>
<span><span class="co">## [4] dplyr_1.1.2         fitdistrplus_1.1-11 survival_3.5-5     </span></span>
<span><span class="co">## [7] MASS_7.3-60         nhanesA_0.7.4       simdata_0.3.0.9003 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] sass_0.4.7        utf8_1.2.3        generics_0.1.3    xml2_1.3.5       </span></span>
<span><span class="co">##  [5] stringi_1.7.12    lattice_0.21-8    digest_0.6.33     magrittr_2.0.3   </span></span>
<span><span class="co">##  [9] evaluate_0.21     grid_4.3.1        mvtnorm_1.2-3     fastmap_1.1.1    </span></span>
<span><span class="co">## [13] rprojroot_2.0.3   plyr_1.8.8        jsonlite_1.8.7    Matrix_1.5-4.1   </span></span>
<span><span class="co">## [17] httr_1.4.7        rvest_1.0.3       purrr_1.0.2       fansi_1.0.4      </span></span>
<span><span class="co">## [21] scales_1.2.1      textshaping_0.3.6 jquerylib_0.1.4   cli_3.6.1        </span></span>
<span><span class="co">## [25] rlang_1.1.1       munsell_0.5.0     splines_4.3.1     withr_2.5.0      </span></span>
<span><span class="co">## [29] cachem_1.0.8      yaml_2.3.7        tools_4.3.1       reshape2_1.4.4   </span></span>
<span><span class="co">## [33] memoise_2.0.1     colorspace_2.1-0  vctrs_0.6.3       R6_2.5.1         </span></span>
<span><span class="co">## [37] lifecycle_1.0.3   stringr_1.5.0     fs_1.6.3          foreign_0.8-84   </span></span>
<span><span class="co">## [41] ragg_1.2.5        pkgconfig_2.0.3   desc_1.4.2        gtable_0.3.4     </span></span>
<span><span class="co">## [45] pkgdown_2.0.7     bslib_0.5.1       pillar_1.9.0      glue_1.6.2       </span></span>
<span><span class="co">## [49] Rcpp_1.0.11       systemfonts_1.0.4 highr_0.10        xfun_0.40        </span></span>
<span><span class="co">## [53] tibble_3.2.1      tidyselect_1.2.0  knitr_1.43        farver_2.1.1     </span></span>
<span><span class="co">## [57] htmltools_0.5.6   labeling_0.4.2    rmarkdown_2.24    compiler_4.3.1</span></span></code></pre>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-NORTA1" class="csl-entry">
Cario, Marne C., and Barry L. Nelson. 1997. <span>“Modeling and
Generating Random Vectors with Arbitrary Marginal Distributions and
Correlation Matrix.”</span> Report. Northwestern University.
</div>
<div id="ref-NORTA2" class="csl-entry">
Ghosh, Soumyadip, and Shane G. Henderson. 2003. <span>“Behavior of the
NORTA Method for Correlated Random Vector Generation as the Dimension
Increases.”</span> <em>ACM Trans. Model. Comput. Simul.</em> 13 (3):
276–94. <a href="https://doi.org/10.1145/937332.937336" class="external-link">https://doi.org/10.1145/937332.937336</a>.
</div>
<div id="ref-Synthpop" class="csl-entry">
Nowok, Beata, Gillian M. Raab, and Chris Dibben. 2016. <span>“Synthpop:
Bespoke Creation of Synthetic Data in r.”</span> <em>Journal of
Statistical Software, Articles</em> 74 (11): 1–26. <a href="https://doi.org/10.18637/jss.v074.i11" class="external-link">https://doi.org/10.18637/jss.v074.i11</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michael Kammer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
